sim,number
Информация о симкартах и их передачах между агентами хранится в таблице sim. При импорте накладной в sim создается запись,
у которой parent_agent_id=NULL,parent_id=id. После добавления симки в базу parent_agent_id проставляется равным 1. Чтобы отобразить
симки, которые когда либо проходили через агента (в независимости от того, передавались они или нет подагентам) достаточно
отфильтровать записи, у которых parent_agent_id равен id нужного агента. При передаче sim от одного агента (либо базы) c
id agent_id1 другому агенту agent_id2, происходит следующее:
1) У записей с parent_agent_id = agent_id1 прописывается окончательная стоимость сим и номера (которая уичтывается в расчете
суммы акта). У этих же записей в act_id записывается id aкта, а в agent_id - agent_id2
2) Для каждой передаваемой симки создается копия, у которой parent_agent_id=agent_id1,parent_act_id=id акта,agent_id=act_id=NULL.
В поле parent_id прописывается значение parent_id из родительской записи.

Т.к. основная информация о номере хранится в sim (так уж исторически сложилось), то нужно как-то связывать запись из number с
симками. для Этого в number есть sim_id. В sim_id хранится id записи симки, которая относится к базе (parent_agent_id=1).
Чтобы проследить всю историю передачи симки между агентами, достаточно сделать запрос select * from sim where parent_id=<number.sim_id> order by id asc
У последней записи всегда agent_id=act_id=NULL.

Если нужно у номера изменить какую либо информацию, которая хранится в sim (icc, тарифный план и т.п.) нужно изменить эту информацию
во всех записях (update sim set .... where parent_id=<number.sim_id>)


subscription_agreement,person,sim
При подключении номера (именно подключении нового абонента) происходит следующее:
Сначала создается запись в subscription_agreement, у которой все ссылки на внешние таблицы равны NULL. Это потому, что
нам нужно сгенерировать номер договора еще до того, как оператор внесет в него данные (номер договора отображается на форме)
после ввода всех данных у этой записи прописываются ссылки на person,number,sim.


file
На данный момент все файлы у нас аплоадятся аяксом. Инфо о всех заапложенных файлах хранится в этой таблице. Со временем в этой
таблице будет появлятся мусор (например зааплоадили скан паспорта, а 'сохранить' на форме не нажали).




