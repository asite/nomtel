Импорт емейлов с балансами мегафона

Для php были доустановлены пакеты php-process (работа с семафорами) и php-imap (работа с imap протоколом)

Процедура импорта емейлов запускается ежеминутно кроном. для этого crontab юзера nomtel содержит строчку:
* * * * * curl -sS http://nomtel.asiteplace.ru/cron/importMegafonBalanceEmails

Процедура импорта емейлов защищена от параллельного запуска нескольких копий при помощи семафора.

Процедура импорта обрабатывает емейлы в папке Inbox и в случае успешной обработки перекладывает письмо в processed папку,
а если возникли проблемы - то в skipped. Сделано так временно. Когда убедимся, что все более-менее работает, обработанные письма надо удалять, т.к. скорее
всего каждое письмо храится в отдельном файле и файловая система может здохнуть, когда в ней будет over 100k файлов в одном каталоге :-)

в var/runtime/mail_parsed.log хранится лог импорта. Для каждого емейла он содержит текст письма и распарсенные данные.
Так же в случае проблем в этом логе появляются дополнительные мессаги (например тариф, указанный в письме, не существует в базе)

Логика обработки данных из письма на данный момент:
1) Ищем номер в базе. Если номера нету, в лог пишем сообщение и считаем, что письмо обработано
2) Если в базе прописан другой личный счет, сохраняем актуальный счет и делаем пометку в истории номера
3) Если в базе прописан другой тарифный план, сохраняем актуальный тарифный план и делаем пометку в истории номера
4) Ищем в списке отчетов по балансам отчет за текущие сутки. Если не находим, то создаем новый
5) Ищем в соответствующую номеру запись в balance_report_number. Если не находим, то создаем. Если находим, обновляем поле balance
6) Пересчитываем статус баланса номера. Анализируются балансы номера за последние 14 отчетов. Сейчас анализатор проставляет следующие статусы:
Новый
ОК
Положительная динамика
Положительная статика
Отрицательная динамика
Отрицательная статика

Как определять терминированные номера и номера, которые есть в базе, но нет в отчетах обсудим, т.к. тут для меня не все понятно.


